# Security Headers Configuration
# Copy this file to your web server's root directory

# For Apache (.htaccess)
# =====================

# Disable Directory Listing (Critical Security)
# Prevents browsing of directory contents
Options -Indexes

<IfModule mod_headers.c>
    # Content Security Policy (CSP)
    # Restricts what resources can be loaded and from where
    Header always set Content-Security-Policy "\
        default-src 'self'; \
        script-src 'self' 'unsafe-inline' 'unsafe-eval' \
            https://cdn.jsdelivr.net \
            https://cdnjs.cloudflare.com \
            https://unpkg.com \
            https://browser.sentry-cdn.com \
            https://www.googletagmanager.com \
            https://www.google-analytics.com; \
        style-src 'self' 'unsafe-inline' \
            https://fonts.googleapis.com \
            https://cdnjs.cloudflare.com; \
        font-src 'self' \
            https://fonts.gstatic.com \
            https://cdnjs.cloudflare.com \
            data:; \
        img-src 'self' \
            https: \
            data: \
            blob:; \
        connect-src 'self' \
            https://www.google-analytics.com \
            https://*.sentry.io; \
        frame-ancestors 'none'; \
        base-uri 'self'; \
        form-action 'self';"

    # X-Frame-Options: Prevent clickjacking attacks
    # DENY = Cannot be embedded in frames at all
    Header always set X-Frame-Options "DENY"

    # X-Content-Type-Options: Prevent MIME type sniffing
    # Forces browsers to respect declared content types
    Header always set X-Content-Type-Options "nosniff"

    # Referrer-Policy: Control referrer information
    # no-referrer = Don't send referrer information
    Header always set Referrer-Policy "no-referrer"

    # Permissions-Policy: Control browser features
    # Disable unnecessary features for privacy and security
    Header always set Permissions-Policy "\
        geolocation=(), \
        microphone=(), \
        camera=(), \
        payment=(), \
        usb=(), \
        magnetometer=(), \
        gyroscope=(), \
        accelerometer=()"

    # X-XSS-Protection: Enable XSS filter (legacy browsers)
    # 1; mode=block = Enable and block page rendering if attack detected
    Header always set X-XSS-Protection "1; mode=block"

    # Strict-Transport-Security (HSTS): Force HTTPS
    # Only enable this if you have HTTPS configured!
    # 31536000 seconds = 1 year
    # Uncomment the line below once HTTPS is set up:
    # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # Cross-Origin-Opener-Policy: Isolate browsing context
    Header always set Cross-Origin-Opener-Policy "same-origin"

    # Cross-Origin-Resource-Policy: Prevent resource theft
    Header always set Cross-Origin-Resource-Policy "same-origin"

    # Cross-Origin-Embedder-Policy: Control resource loading
    Header always set Cross-Origin-Embedder-Policy "require-corp"
</IfModule>

# For Nginx (nginx.conf or site configuration)
# ==============================================
# Add these lines to your server {} block:

# add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://browser.sentry-cdn.com https://www.googletagmanager.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com data:; img-src 'self' https: data: blob:; connect-src 'self' https://www.google-analytics.com https://*.sentry.io; frame-ancestors 'none'; base-uri 'self'; form-action 'self';" always;
# add_header X-Frame-Options "DENY" always;
# add_header X-Content-Type-Options "nosniff" always;
# add_header Referrer-Policy "no-referrer" always;
# add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()" always;
# add_header X-XSS-Protection "1; mode=block" always;
# add_header Cross-Origin-Opener-Policy "same-origin" always;
# add_header Cross-Origin-Resource-Policy "same-origin" always;
# add_header Cross-Origin-Embedder-Policy "require-corp" always;

# Strict-Transport-Security (only with HTTPS):
# add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;


# For Node.js/Express Backend
# ============================
# Install helmet.js: npm install helmet
# Then in your server.js:

# const helmet = require('helmet');
# 
# app.use(helmet({
#   contentSecurityPolicy: {
#     directives: {
#       defaultSrc: ["'self'"],
#       scriptSrc: ["'self'", "'unsafe-inline'", "'unsafe-eval'", 
#                   "https://cdn.jsdelivr.net", 
#                   "https://cdnjs.cloudflare.com",
#                   "https://unpkg.com",
#                   "https://browser.sentry-cdn.com",
#                   "https://www.googletagmanager.com",
#                   "https://www.google-analytics.com"],
#       styleSrc: ["'self'", "'unsafe-inline'", 
#                  "https://fonts.googleapis.com",
#                  "https://cdnjs.cloudflare.com"],
#       fontSrc: ["'self'", 
#                 "https://fonts.gstatic.com",
#                 "https://cdnjs.cloudflare.com",
#                 "data:"],
#       imgSrc: ["'self'", "https:", "data:", "blob:"],
#       connectSrc: ["'self'", 
#                    "https://www.google-analytics.com",
#                    "https://*.sentry.io"],
#       frameAncestors: ["'none'"],
#       baseUri: ["'self'"],
#       formAction: ["'self'"]
#     }
#   },
#   frameguard: { action: 'deny' },
#   referrerPolicy: { policy: 'no-referrer' },
#   hsts: {
#     maxAge: 31536000,
#     includeSubDomains: true,
#     preload: true
#   }
# }));


# Security Headers Testing
# =========================
# 
# After deployment, test your security headers at:
# 1. https://securityheaders.com/
# 2. https://observatory.mozilla.org/
# 3. Chrome DevTools → Network tab → Response Headers
# 
# Expected Security Rating: A+ or A
# 
# Common Issues:
# 
# 1. CSP Violations
#    - Check browser console for CSP errors
#    - Add missing domains to CSP directives
#    - Be careful with 'unsafe-inline' and 'unsafe-eval'
# 
# 2. Mixed Content (HTTPS + HTTP resources)
#    - Ensure all resources use HTTPS
#    - Update hardcoded http:// URLs to https://
# 
# 3. HSTS Warnings
#    - Only enable HSTS after verifying HTTPS works
#    - Can't undo easily (1 year commitment)
# 
# 4. CORS Issues
#    - If using external APIs, may need to adjust CSP
#    - Add domains to connect-src directive


# Additional Security Measures
# =============================

# Disable directory listing
<IfModule mod_autoindex.c>
    Options -Indexes
</IfModule>

# Protect sensitive files
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

<FilesMatch "(^#.*#|\.(bak|conf|dist|fla|in[ci]|log|psd|sh|sql|sw[op])|~)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Disable server signature
ServerSignature Off

# Limit request size (10MB max)
<IfModule mod_php.c>
    php_value upload_max_filesize 10M
    php_value post_max_size 10M
</IfModule>

# Rate limiting for contact form (if using Apache)
# <IfModule mod_ratelimit.c>
#     <Location "/api/contact">
#         SetOutputFilter RATE_LIMIT
#         SetEnv rate-limit 400
#     </Location>
# </IfModule>


# Production Deployment Checklist
# ================================
# 
# Before going live:
# 
# 1. [✓] Copy this file as .htaccess to web root (Apache)
# 2. [✓] Test all security headers are present
# 3. [✓] Verify CSP doesn't break functionality
# 4. [✓] Set up HTTPS certificate (Let's Encrypt recommended)
# 5. [✓] Enable HSTS header (after HTTPS verified)
# 6. [✓] Test on multiple browsers
# 7. [✓] Run security scan (securityheaders.com)
# 8. [✓] Check performance impact (should be minimal)
# 9. [✓] Monitor error logs for CSP violations
# 10. [✓] Update CSP as needed based on violations
# 
# Maintenance:
# - Review security headers quarterly
# - Update CSP when adding new external resources
# - Monitor for new security best practices
# - Keep web server software updated
